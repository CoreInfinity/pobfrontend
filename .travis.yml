os:
  - osx

env:
  global:
    - PATH=/usr/local/opt/qt/bin:$PATH
    - LDFLAGS=-L/usr/local/opt/qt/lib
    - CPPFLAGS=-I/usr/local/opt/qt/include
    - PKG_CONFIG_PATH=/usr/local/opt/qt/lib/pkgconfig
    
branches:
  except:
    - PathOfBuilding
    
addons:
  homebrew:
    packages:
      - make
      - ninja

script:
  - make clean
  - make tools
  - make
  - tar -cf - PathOfBuilding.app | xz -c > PathOfBuilding.darwin.tar.xz

before_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name "aspel"
  - git config --local user.email "aspellip@gmail.com"
  - git tag -f PathOfBuilding
  - git remote add gh https://${TRAVIS_REPO_SLUG%/*}:${GITHUB_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git
  - git push -f gh PathOfBuilding
  - git remote remove gh
  - export TR_TAG="nightly-$(date +'%Y/%m/%d')-$(git log --format=%h -1)"

deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file:
    - "${TRAVIS_BUILD_DIR}/PathOfBuilding.darwin.tar.xz"
  skip_cleanup: true
  name: "PathOfBuilding macOS build"
  body: "Automatically PathOfBuilding dev build by Travis CI $TR_TAG"
  overwrite: true
  target_commitish: $TRAVIS_COMMIT
